version: 2.1

orbs:
  win: circleci/windows@4.1

jobs:
  test_linux:
    parameters:
      ruby_version:
        description: "version tag for the veracross/circleci-ruby-freetds container"
        type: string

    docker:
      - image: veracross/circleci-ruby-freetds:latest
      - image: metaskills/mssql-server-linux-tinytds:2017-GA

    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          name: restore gem cache
          keys:
            - v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-{{ checksum "tiny_tds.gemspec" }}
            - v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-
            - v1-bundle-<< parameters.ruby_version >>-

      - run:
          name: install dependencies
          command: |
            bundle check --path ./vendor/bundle || bundle install --jobs=3 --retry=3 --path vendor/bundle
            bundle clean

      - save_cache:
          name: save gem cache
          paths:
            - ./vendor/bundle
          key: v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-{{ checksum "tiny_tds.gemspec" }}

      - run:
          name: build gem
          command: |
            bundle exec rake build

      - run:
          # imported from setup.sh, although we should do better...
          name: wait for database
          command: |
            sleep 10

      - run:
          name: run tests
          command: |
            TINYTDS_UNIT_HOST=localhost bundle exec rake test

  test_windows:
    parameters:
      ruby_version:
        description: "version tag for the veracross/circleci-ruby-freetds container"
        type: string

    executor:
      name: win/server-2022
      shell: powershell.exe

    environment:
      PATH: "C:\\Ruby<< parameters.ruby_version >>-x64\\bin;%PATH%"
      RAKEOPT: "-rdevkit"
      TESTOPTS: '-v'
      MAKE: "make V=1 -j2"

    steps:
      - run:
          name: install ruby
          command: |
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;
            Invoke-WebRequest -UseBasicParsing -uri "https://github.com/oneclick/rubyinstaller2/releases/download/RubyInstaller-<< parameters.ruby_version >>/rubyinstaller-devkit-<< parameters.ruby_version >>-x64.exe" -OutFile ruby-setup.exe;
            .\ruby-setup.exe /VERYSILENT /NORESTART /DIR=C:/Ruby<< parameters.ruby_version >>-x64;

      - run:
          name: configure msys2
          command: ridk install 1 ;

      - run:
          name: diagnostics
          command: |
            C:/Ruby<< parameters.ruby_version >>/msys64/usr/bin/bash.exe -c "/usr/bin/cat /proc/version"
            perl --version
            ruby --version
            gem --version
            rm .\ruby-setup.exe
      
      - checkout

      - restore_cache:
          name: restore gem cache
          keys:
            - v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-{{ checksum "tiny_tds.gemspec" }}
            - v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-
            - v1-bundle-<< parameters.ruby_version >>-

      - run:
          name: install dependencies
          command: |
            bundle install

      - save_cache:
          name: save gem cache
          paths:
            - ./vendor/bundle
          key: v1-bundle-<< parameters.ruby_version >>-{{ .Branch }}-{{ checksum "tiny_tds.gemspec" }}

      - run:
          name: build
          no_output_timeout: 30m
          command: |
            bundle exec rake ports

      # - run:
      #     # imported from setup.sh, although we should do better...
      #     name: wait for database
      #     command: |
      #       sleep 10

      # - run:
      #     name: run tests
      #     command: |
      #       TINYTDS_UNIT_HOST=localhost bundle exec rake test

workflows:
  test_supported_ruby_versions:
    jobs:
      # - test_linux:
      #     matrix:
      #       parameters:
      #         ruby_version:
      #           - '2.5.3'
      #           - '2.7'


      - test_windows:
          matrix:
            parameters:
              ruby_version:
                - '2.6.8-1'
                - '2.7.5-1'
